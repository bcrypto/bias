% Ticket Management
\section{Управление билетами (УБ)}\label{TM}

\subsection{Обзор}\label{TM.Intro}

Пакет УБ устанавливает требования к билетам, которые выпускаются СИ и 
распространяются в федерации, в том числе требования по содержанию билетов,
их защите, логике их обработки. 

СИ по результатам успешной аутентификации пользователя выпускает БА.
Этот билет содержит утверждения о событии аутентификации~---
идентификаторы пользователя, СИ и целевой ПС, время выпуска, 
срок действия и др.  
%
Идентификатор пользователя является не только утверждением аутентификации,
но и утверждением о самом пользователе.
Билет может содержать и другие утверждения о~пользователе.

БА используется для доступа к ресурсам ПС со стороны пользователя:
ПС открывает доступ только после проверки корректности билета.
%
Кроме этого, БА является квитанцией аутентификации, может предъявляться другим
сторонам и, таким образом,  служить основой сервисов <<одного окна>> (single
sign-on).
%
Наконец, пользователь может обменять БА на БС и поддерживать с помощью 
последнего аутентифицированный сеанс с ПС или~СИ. 

Дополнительно к билету аутентификации СИ выпускает БД и БО.
БД позволяет получить ПС утверждения о пользователе не напрямую,
а косвенно, через СР. В тех случаях, когда БД имеет небольшой срок 
действия, БО позволяет перевыпустить БД без повторной аутентификации. 

СИ и другие стороны могут выпускать другие билеты. 
%
Концептуально, билет~--- это информация о пользователе, 
ссылка на ресурсы пользователя или на другие билеты. 
Так БА~--- это информация об аутентификации пользователя, 
БД~--- ссылка на ресурсы, 
БО~--- ссылка на БД, 
БС~--- ссылка на сеанс пользователя.
%
При таком толковании взаимодействие сторон инфраструктуры аутентификации 
можно представить себе как обмен одних билетов на другие.
%
Обмен начинается с аутентификаторов и заканчивается утверждениями.

Билеты делятся на два класса: именные и на предъявителя.
Именной билет содержит идентификационные данные владельца.
При необходимости владелец может доказать, что билет принадлежит ему.
Билет на предъявителя является безличным. 
Решение о корректности такого билета принимается в момент предъявления.
Воспользоваться билетом может любой предъявитель и поэтому билет 
следует хранить в секрете.

Билеты, которые СИ выпускает по результатам успешной аутентификации 
пользователя (БА, БД, БО), могут передаваться ПС двумя способами:
\begin{itemize}
\item[--]
через КП пользователя (длинная передача);
\item[--]
напрямую (короткая передача).
\end{itemize}
%
В последнем случае ПС предварительно получает от СИ специальный ссылочный билет
(код авторизации в терминологии OIDC).
%
ПС получает ссылочный билет через КП пользователя и пересылает его СИ.
СИ в ответ отправляет ПС требуемые билеты.

При длинной передаче билеты передаются по соединениям
СИ~--- КП и КП~--- ПС через потенциально небезопасную 
среду эксплуатации КП. При короткой передаче используется
только прямое соединение СИ~--- ПС. Короткая передача надежнее.
С другой стороны, длинная передача не нуждается в дополнительном ссылочном 
билете, она эффективнее.

БД, БО и ссылки на них, которые выпускает СИ после предъявления корректного 
аутентификатора пользователя, выступают в роли вторичных аутентификаторов.
%
Вторичный аутентификатор лишь косвенно свидетельствуют о подлинности 
пользователя, поскольку ПС не может связать аутентификатор с пользователем. 
%
Вторичный аутентификатор, как правило, является секретным билетом на 
предъявителя.

\if0
Как правило, СИ передает ПС вторичные аутентификаторы через КП (см. 
рисунок~\ref{Fig.TM.Secondary}).

\begin{figure}[bht]
\begin{center}
\includegraphics[width=10cm]{../figs/Secondary}
\end{center}
\caption{Вторичные аутентификаторы}
\label{Fig.TM.Secondary}
\end{figure}

ПС предъявляет код авторизации и БО серверу идентификации,
а БД~--- серверу ресурсов.
%
Предъявляя вторичный аутентификатор, ПС получает в ответ 
утверждения или другие билеты (новые аутентификаторы).
%
Например, предъявляя БД, ПС получает в ответ утверждения.
Предъявляя БО, получает БД.
Предъявляя код авторизации, получает БД и БО.

Вторичный аутентификатор попадает к ПС от пользователя. 
Он выпускается до БА (код авторизации) или вместе с 
БА (БД, БО).  

В настоящем стандарте используются следующие правила,
уточняющие процедуры управления билетами:
\begin{enumerate}
\item
БА и БО выпускаются СИ по итогам успешной аутентификации. 
\item
БД выпускается СИ по итогам успешной аутентификации или при предъявлении БО. 
\item
БА касается пользователя, прошедшего аутентификацию. 
\item
БД и БО касаются ресурсов пользователя, прошедшего аутентификацию. 
\item
БА~--- именной билет, БД и БО~--- билеты на предъявителя.
\item
БА~--- выпускается всегда после успешной аутентификации, 
БД и БО~--- при необходимости (по запросу).
\item
При повторной аутентификации пользователя и получении новых БД и БО, 
выданные ему ранее билеты не отзываются.
\end{enumerate}
\fi

\subsection{Требования}\label{TM.Reqs}

% БА 

\req{УБ}{1--3}
БА должен содержать:
\begin{itemize}
\item
идентификатор пользователя, который прошел аутентификацию;
\item
идентификатор ПС, которая запрашивала аутентификацию;
\item
уникальный идентификатор билета;
\item
время выпуска билета;
\item
время окончания действия билета;
\item
время первичной аутентификации (если доступно);
\item
подпись содержимого билета, выработанная СИ.
\end{itemize}

Подпись билета должна сопровождаться сертификатом открытого ключа СИ или 
ссылкой на сертификат.  

\begin{note}
Билет может дополнительно содержать: 
уровень гарантий аутентификации;
сведения о выполненном протоколе аутентификации;
дополнительные сведения о пользователе.
\end{note}

\begin{note}
В некоторых случаях по соображениям приватности требуется, 
чтобы различные ПС получали разные идентификаторы одного и то же 
пользователя.
%
Такие контекстнозависимые идентификаторы (псевдонимы) СИ может генерировать
с помощью алгоритмов имитозащиты, используя свой секретный ключ и обрабатывая 
на нем первоначальный идентификатор пользователя и идентификатор целевой ПС.
\end{note}

\req{УБ}{2, 3}
БА должен быть конвертован на открытом ключе ПС.

\req{УБ}{3}
БА должен \addendum{содержать открытый ключ пользователя, прошедшего 
аутентификацию, или ссылку на открытый ключ}.
%
Пользователь должен доказать владение \addendum{личным ключом, соответствующим  
открытому,} при предъявлении билета ПС.

\begin{note}
\addendum{
Открытый ключ пользователя может распространяться в форме сертификата, 
зарегистрированного в качестве открытого аттестата. 
%
При этом соответствующий личный ключ размещается на КТ, а при 
аутентификации пользователь доказывает владение токеном и, как следствие, 
личным ключом.
%
Возможны другие сценарии. Например, БА может ссылаться на одноразовые открытый 
и личный ключи, которые формируются непосредственно в ходе протокола
аутентификации, или на долговременные ключи, которые не используются для
аутентификации.
}
\end{note}

\begin{note}
\addendum{
Для доказательства владения личным ключом при предъявлении БА пользователь
может подписать билет или подпись СИ, вложенную в него. 
%
Если личный ключ используется в алгоритмах ЭЦП за пределами инфраструктуры 
аутентификации, то предварительно следует проверить подпись СИ.
%
Это защитит пользователя от подписи сообщений, навязываемых под видом БА или 
его частей.
}
\end{note}

\req{УБ}{1--3}
ПС не должна принимать БА, подпись которого некорректна.
%
\addendum{ПС не должна принимать БА, если сертификат открытого ключа 
подписавшей билет СИ недействителен}.
%
ПС не должна принимать БА, предназначенные не ей.
%
ПС не должна принимать БА, время окончания действия которого раньше текущего 
момента времени \addendum{или момента начала действия сертификата СИ}.  
%
ПС не должна принимать БА, время выпуска которого позже текущего момента 
времени \addendum{или момента окончания действия сертификата СИ}. 

% вторичный аутентификатор

\req{УБ}{1--3}
БД, БО и ссылочные билеты должны передаваться между сторонами федерации по 
защищенным соединениям. 

\req{УБ}{1--3}
БД и БО должны содержать не менее 128 битов энтропии.
% 
Ссылочный билет должен содержать не менее 64 битов энтропии 
и использоваться однократно.  

\req{УБ}{3}
Должна использоваться прямая передача БД и БО от СИ к ПС.

\req{УБ}{1--3}
СИ и СР, которым ПС предъявляет БД и БО, должны связывать билеты с ответами.
%
Связывание должно быть реализовано с помощью ЭЦП (ответ, включающий ссылку на 
билет, подписывается) или через передачу по защищенному соединению 
(с аутентификацией отправителя). 

% СР

\req{УБ}{3}
СР должен подписывать утверждения, которые формирует в ответ на БД. 

% todo: убрать?
% todo: проверка БД?
