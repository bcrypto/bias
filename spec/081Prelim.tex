\section{Общие сведения}\label{OIDC.Prelim}

Технология OIDC устанавливает интерфейсы веб-сервисов, реализующих элементы 
аутентификации и федерации. 
%
Работа с веб-сервисом состоит в обращении с запросом на поддерживаемый им
коммуникационный узел. Ответы используются либо непосредственно, либо участвуют
в формировании запросов на другие узлы. Перечень задействованных узлов
представлен в таблице~\ref{Table.OIDC.Endpoints}.

\begin{table}[hbt]
\caption{Узлы OIDC}\label{Table.OIDC.Endpoints}
\begin{tabular}{|l|l|c|c|c|}
\hline
Узел & Назначение & Размещение\\
\hline
\hline
Authorization & Аутентификация и авторизация & СИ\\
%
Redirection & Перенаправление & ПС\\
%
Token & Обмен кода авторизации на билеты & СИ\\
%
UserInfo & Предоставление сведений о пользователе & СР\\
\hline
\end{tabular}
\end{table}

Узел Redirection является техническим, он используется
для передачи управления ПС через механизм перенаправления протокола HTTP.
%
Узел UserInfo отвечает за обслуживание ресурсов 
пользователей. Кроме UserInfo в инфраструктуре аутентификации могут 
использоваться другие узлы ресурсов.

Правила обращения к узлам и очередность обращений описываются 
коммуникационной схемой. Схема выбирается при обращении на узел 
Authorization (см. таблицу~\ref{Table.OIDC.RespType}).

В настоящем стандарте определяются 3 схемы: Code, Implicit и Hybrid. 
%
Первую схему рекомендуется применять при наличии прямого защищенного 
соединения между СИ и ПС с взаимной аутентификацией сторон.
% 
% todo: для аутентификации перед СИ ПС дб способна управлять секретами
% аутентификации (confidential client)
%
Вторая схема может использоваться при отсутствии прямого соединения:
передача данных от СИ к ПС осуществляется через КП.
%
% todo: в случае public client (ПС не может защитить свои критические объекты)
% вторая схема является единственно возможной
%
Третья схема комбинирует элементы первой и второй: данные 
передаются от СИ к ПС и напрямую, и через КП. При этом обеспечивается 
б\'{о}льшая гибкость, создаются возможности усиления гарантий безопасности.
%
Основные различия между схемами перечислены в таблице~\ref{Table.OIDC.Flows}.

\begin{table}[H]
\caption{Отличия между коммуникационными схемами}\label{Table.OIDC.Flows}
\begin{tabular}{|l|c|c|c|}
\hline
\multirow{2}{*}{Свойство} & \multicolumn{3}{c|}{Схема}\\
\cline{2-4}
& Code & Implicit & Hybrid\\
\hline
\hline
Билеты возвращаются с узла Authorization & Да & Нет & Нет\\
Билеты возвращаются с узла Token & Нет & Да & Нет\\
Билеты не открываются КП & Да & Нет & Нет\\
ПС должна быть аутентифицирована перед СИ & Да & Нет & Да\\
Возможно обновление билетов & Да & Нет & Да\\
Выполнение за один цикл ПС~-- КП~-- СИ~-- ПС & Нет & Да & Нет\\
Основные пересылки между ПС и СИ & Да & Нет & Варьируется\\
\hline
\end{tabular}
\end{table}

Узлы OIDC описываются следующими элементами:
\begin{itemize}
\item сетевой адрес (URI);
\item HTTP-метод обращения к узлу (GET или POST);
\item формат запроса;
\item формат ответов (успешного и об ошибке);
\item схема кодирования параметров запросов и ответов.
\end{itemize} 

Форматы запросов и ответов подробно определяются в приложении~\ref{REQRESP}.
В настоящем разделе форматы определяются  кратко, в виде обзорных таблиц.
% 
В таблицах описываются параметры запросов и ответов.
Для каждого параметра указывается обязательность его включения в запрос или 
ответ, приводится краткое описание, дается ссылка на подробное описание.
%
Параметр, обязательный для включения, помечается знаком <<$+$>>,
рекомендуемый для включения~--- символом <<p>>,
условно обязательный~--- символом <<у>>,
опциональный~--- символом <<о>>. Сочетание <<ру>> означает рекомендацию 
при выполнении определенного условия.

Предусмотрены следующие схемы кодирования параметров запросов и ответов:
\begin{enumerate}
\item
Query. 
Имена и значения параметров кодируются в формате 
\lstinline{"application/x-www-form-urlencoded"}, определенном в~\cite{HTML4}. 
%
Результат кодирования добавляется к адресу целевого узла в качестве 
компонента \lstinline{query} (после знака <<?>>, см.~\cite{RFC3986}).
%
Схема используется для кодирования прямых запросов и перенаправляемых ответов.
%
В последнем случае целевым является узел перенаправления.
%
Адрес этого узла, дополненный компонентом \lstinline{query}, 
помещается в заголовок \lstinline{Location} HTTP-ответа перенаправления 
(код 302). 

\item
Fragment.
Имена и значения параметров кодируются в формате 
\lstinline{"application/x-www-form-urlencoded"}.
%
Результат кодирования добавляется к адресу целевого узла в качестве 
компонента \lstinline{fragment} (после знака <<\#>>, см.~\cite{RFC3986}).
%
Схема используется для кодирования перенаправляемых ответов.
%
Адрес узла перенаправления, дополненный компонентом \lstinline{fragment}, 
помещается в заголовок \lstinline{Location} HTTP-ответа перенаправления. 

\item
Form.
Имена и значения параметров кодируются в формате 
\lstinline{"application/x-www-form-urlencoded"}. 
%
Результат кодирования помещается в тело HTTP-пакета. 
%
Название формата указывается в заголовке \lstinline{Content-Type} 
(тип содержимого) пакета.  

\item
JSON.
Имена и значения параметров кодируются в формате \lstinline{"application/json"}, 
определенном в~\cite{RFC4627}. В результате кодирования получается объект 
(контейнер) JSON, который помещается в тело HTTP-пакета. 
Название формата указывается в заголовке \lstinline{Content-Type} пакета. 
%
Параметры являются записями первого уровня объекта JSON.
Названия параметров и строковые значения представляются строками JSON.
Числовые значения представляются числами JSON.
Очередность параметров в контейнере не имеет значения.

\item
JWT.
Имена и значения параметров записываются в объект JSON, который затем 
встраивается в объект JWT (см.~приложение~\ref{JWT}).
%
Полученный объект кодируется в формате \lstinline{"application/jwt"}, 
определенном в~\cite{RFC7519}.
%
Результат кодирования помещается в тело HTTP-пакета. Название формата 
указывается в заголовке \lstinline{Content-Type} пакета. 

\item
Bearer.
Используется только для БД.
%
Билет, предваряемый префиксом \lstinline{"Bearer"}, 
размещается в заголовке \lstinline{Authorization} HTTP-пакета.
%
Формат заголовка определен в~\cite{RFC6750}.

\item
WWW-Authenticate.
Имена и значения параметров, описывающих ошибки, помещаются в заголовок 
\lstinline{WWW-Authenticate} HTTP-ответа об ошибке. 
%
Формат заголовка определен в~\cite{RFC6750}.
%
В заголовке размещается строка с префиксом \lstinline{"Bearer"}, 
а далее через запятую перечисляются параметры и их значения.
\end{enumerate}

В соответствии с требованиями, установленными в разделах~\ref{AUTH} 
и~\ref{FED}, взаимодействие сторон OIDC выполняется по защищенным 
соединениям. В частности, запросы на узлы и ответы с них должны защищаться при 
пересылке. Для организации защиты рекомендуется использовать протокол TLS,
определенный в СТБ~34.101.65.
%
% todo: Дополнительно серверы (СИ, СР и ПС) могут соединяться каналами, 
% защита в которой обеспечивается собственными протоколами. 
%
% При использовании сетевых ТА передача данных от СИ к~КП 
% во время аутентификации может выполняться по защищенным 
% каналам GSM. 

