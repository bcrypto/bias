\hiddensection{Запрос авторизации~/ аутентификации}\label{REQRESP.Auth}

\subsection{Подготовка запроса}\label{REQRESP.Auth.Pre}

Запрос аутентификации формируется ПС после того как пользователь
инициирует (с помощью КП) процесс аутентификации.
%
Если пользователь может аутентифицироваться с помощью нескольких СИ,
то ПС должна явно отслеживать выбор пользователем конкретного СИ, 
что подразумевает сохранение на ПС информации о выбранной СИ с последующим 
использованием данной информации для проверки того, что ответы на запросы были 
получены от нужной СИ. Дополнительно ПС может неявно отслеживать выбор 
пользователем СИ. Для неявного отслеживания ПС может использовать различные 
сетевые адреса (URI) перенаправления для различных СИ.

\subsection{Обработка запроса}\label{REQRESP.Auth.Req} 

При получении запроса аутентификации СИ должна проверить, что все включенные в
запрос параметры являются корректными и все требуемые параметры включены в
запрос.
%
СИ должна игнорировать нераспознанные параметры.

Если запрос является корректным, то СИ в зависимости от параметров запроса 
либо аутентифицирует пользователя, либо определяет, что пользователь уже 
аутентифицирован. 
%
Интерфейс пользователя во время аутентификации определяется в зависимости 
от параметров запроса и методов аутентификации.

СИ должна попытаться аутентифицировать пользователя в следующих случаях:
\begin{enumerate} 
\item Пользователь еще не аутентифицирован.

\item Запрос аутентификации содержит параметр \lstinline{prompt} со 
значением \lstinline{"login"}. В этом случае СИ должна повторно 
аутентифицировать пользователя даже в том случае, если пользователь уже 
аутентифицирован. 
\end{enumerate} 

СИ нельзя взаимодействовать с пользователем в случае,
если запрос аутентификации содержит параметр \lstinline{prompt} со 
значением \lstinline{"none"}. В данном случае СИ должна возвратить ошибку,
если пользователь еще не аутентифицирован или не может быть аутентифицирован  
способом, не требующим интерактивного взаимодействия с ним.

Если в запросе аутентификации в утверждении \lstinline{sub} передан 
идентификатор пользователя, то СИ должна возвратить положительный ответ на 
запрос в случае, когда пользователь c идентификатором \lstinline{sub} 
уже имеет активный аутентифицированный сеанс со СИ или успешно аутентифицирован 
по данному запросу.
%
Запрос аутентификации с определенным значением утверждения \lstinline{sub} может
быть сделан либо путем включения параметра \lstinline{id_token_hint}, либо путем
включения параметра \lstinline{claims} с определенным значением для утверждения
\lstinline{sub} (см.~\ref{CLAIMS.ReqWith}).

% todo: СИ НЕ ДОЛЖНА возвращать билет аутентификации 
% и/или билет доступа для других пользователей, 
% даже если они имеют активный сеанс с СИ.

При включении в параметр \lstinline{scope} лексемы \lstinline{"offline_access"}
СИ должна его игнорировать, если выполняется хотя бы одно из условий:
\begin{itemize}
\item
коммуникационная схема, заданная в параметре \lstinline{response_type}, 
не предусматривает выпуск БО;
\item
параметр \lstinline{prompt} не содержит значение \lstinline{"consent"}.
\end{itemize}

Пример перенаправленного ответа ПС, который инициирует КП на передачу запроса 
аутентификации на СИ: 
%
\begin{lstlisting}
HTTP/1.1 302 Found
Location: https://server.example.com/authorize?
  response_type=code
  &scope=openid%20profile%20email
  &client_id=s6BhdRkqt3
  &state=af0ifjcsldkj
  &redirect_uri=https%3A%2F%2Fclient.example.org%2Fcb
\end{lstlisting}

Пример запроса, который КП высылает СИ при получении от ПС приведенного 
выше перенаправленного ответа:
%
\begin{lstlisting}
GET /authorize?
  response_type=code
  &scope=openid%20profile%20email
  &client_id=s6BhdRkqt3
  &state=af0ifjcsldkj
  &redirect_uri=https%3A%2F%2Fclient.example.org%2Fcb HTTP/1.1
Host: server.example.com
\end{lstlisting}

\subsection{Обработка успешного ответа}\label{REQRESP.Auth.Resp}

При получении успешного ответа с узла Authorization ПС должна 
проверить, что все требуемые параметры включены в ответ
и что все параметры в ответе являются корректными.
%
ПС должна игнорировать нераспознанные параметры ответа.

Если в ответе возвращается БА, то ПС должна обработать его по правилам, 
установленным в~\ref{IDTOKEN.Process}. 
%
Если в ответе возвращаются БА и БД, то ПС должна проверить, что хэш-значение
в утверждении \lstinline{at_hash} БА соответствует БД.

Пример успешного ответа для коммуникационной схемы Code:
%
\begin{lstlisting}
HTTP/1.1 302 Found
Location: https://client.example.org/cb?
  code=SplxlOBeZQQYbYS6WxSbIA
  &state=af0ifjcsldkj
\end{lstlisting}

Пример успешного ответа для коммуникационной схемы Implicit:
%
\begin{lstlisting}
HTTP/1.1 302 Found
Location: https://client.example.org/cb#
  access_token=mF_9.B5f-4.1JqM3dpR+G~
  &token_type=bearer
  &id_token=eyJ0...NiJ9.eyJ1c...I6IjIifX0.DeWt4Qu...ZXso
  &expires_in=300
  &state=af0ifjcsldkj
\end{lstlisting}

\subsection{Ответ об ошибке}\label{REQRESP.Auth.Error}

Если запрос аутентификации признан некорректным по причине отсутствия,
неправильности записи или несовпадения URI перенаправления, а также если в
запросе идентификатор ПС отсутствует или указан неверно, то СИ должна
проинформировать пользователя об ошибке, при этом СИ нельзя автоматически
перенаправлять КП по неверному URI перенаправления. Ошибки протокола HTTP
возвращаются КП используя подходящий код статуса HTTP.

Если запрос аутентификации признан некорректным по причинам, не связанным с
отсутствием или некорректностью URI перенаправления, или если пользователь не
смог пройти аутентификацию или ему было отказано в прохождении аутентификации,
то СИ должна возвратить ответ об ошибке c одним из следующих кодов:
%
\lstinline{invalid_request}, 
\lstinline{access_denied},
\lstinline{unauthorized_client}, 
\lstinline{invalid_scope},
\lstinline{unsupported_response_type},
\lstinline{server_error}, 
\lstinline{temporarily_unavailable}, 
\lstinline{interaction_required},
\lstinline{login_required},
\lstinline{consent_required},
\lstinline{account_selection_required},
\lstinline{invalid_request_uri},
\lstinline{invalid_request_object},
\lstinline{request_not_supported}, 
\lstinline{request_uri_not_supported}. 
%\lstinline{registration_not_supported}.

Пример ответа об ошибке с перенаправлением КП на ПС:
\begin{lstlisting}
HTTP/1.1 302 Found
Location: https://client.example.org/cb?
  error=invalid_request
  &error_description=Unsupported%20response_type%20value
  &state=af0ifjsldkj
\end{lstlisting}

